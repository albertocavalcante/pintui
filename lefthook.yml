# Lefthook git hooks configuration
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    rust-fmt:
      glob: "rust/**/*.rs"
      run: cargo fmt --manifest-path rust/Cargo.toml -- --check
      fail_text: "Run 'cargo fmt --manifest-path rust/Cargo.toml' to fix formatting"

    rust-clippy:
      glob: "rust/**/*.rs"
      run: cargo clippy --manifest-path rust/Cargo.toml --all-targets -- -D warnings
      fail_text: "Fix clippy warnings before committing"

    rust-check:
      glob: "rust/**/*.rs"
      run: cargo check --manifest-path rust/Cargo.toml
      fail_text: "Fix compilation errors before committing"

    workflow-lint:
      glob: ".github/workflows/*.{yml,yaml}"
      run: |
        if command -v ghalint &> /dev/null && command -v actionlint &> /dev/null; then
          ghalint run -c tools/lint/ghalint.yaml && actionlint {staged_files}
        else
          echo "Skipping workflow lint (ghalint/actionlint not installed)"
        fi
      fail_text: "Fix GitHub Actions workflow issues"

    yaml-fmt:
      glob: "**/*.{yml,yaml}"
      run: |
        if command -v prettier &> /dev/null; then
          prettier --check {staged_files}
        else
          echo "Skipping YAML format check (prettier not installed)"
        fi
      fail_text: "Run 'prettier --write' to fix YAML formatting"

    md-fmt:
      glob: "**/*.md"
      run: |
        if command -v prettier &> /dev/null; then
          prettier --check --prose-wrap always {staged_files}
        else
          echo "Skipping Markdown format check (prettier not installed)"
        fi
      fail_text: "Run 'prettier --write --prose-wrap always' to fix Markdown formatting"

pre-push:
  parallel: true
  commands:
    rust-test:
      run: cargo test --manifest-path rust/Cargo.toml
      fail_text: "Tests must pass before pushing"

commit-msg:
  commands:
    conventional:
      run: |
        msg=$(cat {1})
        if ! echo "$msg" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+'; then
          echo "Commit message must follow Conventional Commits format:"
          echo "  <type>[optional scope]: <description>"
          echo ""
          echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          echo ""
          echo "Your message: $msg"
          exit 1
        fi
